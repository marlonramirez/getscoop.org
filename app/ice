#!/usr/bin/env php
<?php

if (php_sapi_name() !== 'cli') {
    exit;
}
require 'scoop/Context.php';
\Scoop\Context::load('app/config');
array_shift($argv);
$commandName = array_shift($argv);
$trace = $commandName === '--trace';
if ($trace) {
    $commandName = array_shift($argv);
}
$writer = \Scoop\Context::inject('\Scoop\Command\Writer');
$commandBus = \Scoop\Context::inject('\Scoop\Command\Bus');
if ($commandName !== null && preg_match('/^[a-zA-Z]/', $commandName)) {
    try {
        $commandBus->dispatch($commandName, $argv);
    } catch (Exception $ex) {
        $code = intval($ex->getCode());
        $writer->withError()->write('<danger:[ERROR]!> <error:' . $ex->getMessage() . ($trace ? PHP_EOL . $ex->getTraceAsString() : '') . '!>');
        exit($code ? $code : 1);
    }
} else {
    $commands = $commandBus->getCommands();
    $writer->write(
        'ICE/SCOOP version ' . \Scoop\Context::inject('\Scoop\Bootstrap\Environment')->getVersion(),
        '',
        'Commands:'
    );
    $maxlength = max(array_map('strlen', array_keys($commands)));
    foreach ($commands as $command => $controller) {
        $command = str_pad($command, $maxlength);
        $writer->write("$command => <link:$controller.php!>");
    }
    $writer->write(
        '',
        'Options:',
        '--trace => show exception stack when execute a command',
        '',
        'Run app/ice COMMAND --help for more information'
    );
}
